name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

env:
  SERVICE_NAME: osrs-ai-wiki-chat

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push image
        run: |
          # Guard against accidental trailing newlines in GitHub Secrets
          PROJECT_ID="$(printf '%s' "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\r\n')"
          REGION="$(printf '%s' "${{ secrets.GCP_REGION }}" | tr -d '\r\n')"
          REPO="$(printf '%s' "${{ secrets.GCP_ARTIFACT_REPO }}" | tr -d '\r\n')"

          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${{ env.SERVICE_NAME }}:${{ github.sha }}"

          docker build -t "$IMAGE" .
          docker push "$IMAGE"

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        run: |
          # Default to the current supported model if not configured as a secret
          GEMINI_MODEL_VALUE="${{ secrets.GEMINI_MODEL || 'gemini-2.5-flash' }}"
          VERTEX_LOCATION_VALUE="${{ secrets.GCP_VERTEX_LOCATION || 'us-central1' }}"

          # Guard against accidental trailing newlines in GitHub Secrets
          PROJECT_ID_VALUE="$(printf '%s' "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\r\n')"
          GOOGLE_CSE_API_KEY_VALUE="$(printf '%s' "${{ secrets.GOOGLE_CSE_API_KEY }}" | tr -d '\r\n')"
          GOOGLE_CSE_CX_VALUE="$(printf '%s' "${{ secrets.GOOGLE_CSE_CX }}" | tr -d '\r\n')"
          YOUTUBE_API_KEY_VALUE="$(printf '%s' "${{ secrets.GCP_YT_API_KEY }}" | tr -d '\r\n')"

          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image "$IMAGE" \
            --region "${{ secrets.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --service-account "${{ secrets.GCP_RUNTIME_SERVICE_ACCOUNT_EMAIL }}" \
            --set-env-vars "APP_ENV=prod,RAG_DB_PATH=/tmp/rag.sqlite,RAG_TOP_K=5,VERTEX_LOCATION=${VERTEX_LOCATION_VALUE},GEMINI_MODEL=${GEMINI_MODEL_VALUE}" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID_VALUE}" \
            --set-env-vars "GOOGLE_CSE_API_KEY=${GOOGLE_CSE_API_KEY_VALUE}" \
            --set-env-vars "GOOGLE_CSE_CX=${GOOGLE_CSE_CX_VALUE}" \
            --set-env-vars "YOUTUBE_API_KEY=${YOUTUBE_API_KEY_VALUE}" \
            --set-env-vars "PAYPAL_ENV=${{ secrets.PAYPAL_ENV }}" \
            --set-env-vars "PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}" \
            --set-env-vars "PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}" \
            --set-env-vars "PAYPAL_RETURN_URL=${{ secrets.PAYPAL_RETURN_URL }}" \
            --set-env-vars "PAYPAL_CANCEL_URL=${{ secrets.PAYPAL_CANCEL_URL }}"

      - name: Show service URL
        run: |
          gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ secrets.GCP_REGION }}" \
            --format='value(status.url)'
